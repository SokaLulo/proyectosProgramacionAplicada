import network
import urequests
import ujson
from machine import Pin
import utime


WIFI_SSID = "ELBE"
WIFI_PASS = "Miguel123"
SERVER_URL = "http://192.168.1.15:3000/data"  
TRIG_PIN = 5
ECHO_PIN = 18
ECHO_TIMEOUT_US = 30000
SAMPLE_INTERVAL = 1.0  


trig = Pin(TRIG_PIN, Pin.OUT)
echo = Pin(ECHO_PIN, Pin.IN)
trig.value(0)
utime.sleep_ms(50)

def pulse_trigger():
    trig.value(0)
    utime.sleep_us(2)
    trig.value(1)
    utime.sleep_us(10)
    trig.value(0)

def measure_once(timeout_us=ECHO_TIMEOUT_US):
    pulse_trigger()
    t0 = utime.ticks_us()
    # esperar subida
    while echo.value() == 0:
        if utime.ticks_diff(utime.ticks_us(), t0) > timeout_us:
            return None
    t_start = utime.ticks_us()
   
    while echo.value() == 1:
        if utime.ticks_diff(utime.ticks_us(), t_start) > timeout_us:
            return None
    t_end = utime.ticks_us()
    return utime.ticks_diff(t_end, t_start)

def duration_to_cm(d_us):
    return None if d_us is None else d_us / 58.0


sta_if = network.WLAN(network.STA_IF)

def wifi_connect(ssid, password, timeout=20):
    """Conecta al WiFi y devuelve True/False. Imprime estado para debug."""
    try:
        if not sta_if.active():
            sta_if.active(True)
        if sta_if.isconnected():
            print("Ya conectado. IP:", sta_if.ifconfig()[0])
            return True
        print("Intentando conectar a '{}' ...".format(ssid))
        sta_if.connect(ssid, password)
        t0 = utime.time()
        while not sta_if.isconnected():
            if utime.time() - t0 > timeout:
                print("Timeout conectando a WiFi")
                return False
            utime.sleep_ms(200)
        print("Conectado. IP:", sta_if.ifconfig()[0])
        return True
    except Exception as e:
        print("Excepción en wifi_connect:", e)
        return False


def post_json(url, payload, timeout=5000):
    """
    Envía JSON con urequests de forma robusta.
    Devuelve (status_int_or_None, text_or_error).
    """
    try:
        headers = {"Content-Type": "application/json"}
        r = urequests.post(url, data=ujson.dumps(payload), headers=headers)
        
        status = None
        try:
            status = r.status_code
        except Exception:
            try:
                status = r.status
            except Exception:
                status = None
       
        body = None
        try:
            body = r.text
        except Exception:
            try:
                
                body = r.content if hasattr(r, 'content') else r.read()
                
                if isinstance(body, (bytes, bytearray)):
                    try:
                        body = body.decode('utf-8')
                    except Exception:
                        body = str(body)
            except Exception:
                body = '<sin cuerpo>'
        
        try:
            r.close()
        except Exception:
            pass
        return (status, body)
    except Exception as e:
        
        return (None, "Exception post_json: {}".format(e))


def main():
    if not wifi_connect(WIFI_SSID, WIFI_PASS):
        print("No se pudo conectar a WiFi. Revisa SSID/Password.")
        return
    while True:
        ts_ms = utime.ticks_ms()
        dur = measure_once()
        dist = duration_to_cm(dur)
        payload = {
            "timestamp_ms": int(ts_ms),
            "duration_us": None if dur is None else int(dur),
            "distance_cm": None if dist is None else round(dist, 2)
        }
        print("Enviando:", payload)
        status, resp = post_json(SERVER_URL, payload)
        if status is None:
            print("Error envio:", resp)
        else:
            print("Servidor respondió:", status, resp)
       
        utime.sleep_ms(int(SAMPLE_INTERVAL * 1000))

if _name_ == "_main_":
    try:
        main()
    except Exception as e:
        
        print("Error en main():", e)
